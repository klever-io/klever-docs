name: Check Links

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight
  workflow_dispatch:
  pull_request:
    paths:
      - '**/*.mdx'
      - '**/*.md'

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    
    - name: Build site
      run: pnpm build
    
    - name: Start server
      run: |
        pnpm start &
        sleep 10  # Wait for server to start
    
    - name: Check for broken links
      uses: lycheeverse/lychee-action@v1
      with:
        args: >
          --verbose
          --no-progress
          --base http://localhost:3000
          --exclude-mail
          --exclude-tel
          --exclude localhost:3000/api
          --accept 200,204,301,302,303
          http://localhost:3000
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload link check results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: link-checker-report
        path: lychee-out.md